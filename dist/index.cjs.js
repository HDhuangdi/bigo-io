"use strict";var t;!function(t){t.match="match",t.contain="contain",t.absolutely="absolutely",t.startsWidth="startsWidth",t.endsWidth="endsWidth"}(t||(t={}));var e,n=t;!function(t){t[t.CONNECTING=0]="CONNECTING",t[t.OPEN=1]="OPEN",t[t.CLOSING=2]="CLOSING",t[t.CLOSED=3]="CLOSED"}(e||(e={}));var o=e;function i(t){throw new Error("[bigo-io warn]:"+t)}var s=function(){function t(e){this.heartBeatReceiptFlag=!1,this.messageHeartBeatCheckList=[],this.checkOption(e),this.option=e,e.url.startsWith("/")&&(this.url=t.baseURL+e.url),this.createConnection()}return t.prototype.checkOption=function(t){void 0===window.WebSocket&&i("Your browser doesn't support websocket!"),t&&Object.keys(t).length||i("invalid options!"),t.url||i("invalid url!")},t.prototype.createConnection=function(){this.ws=new WebSocket(this.url),this.ws.onopen=this.onOpen.bind(this),this.ws.onclose=this.onClose.bind(this),this.ws.onmessage=this.onMessage.bind(this),this.ws.onerror=this.onError.bind(this)},t.create=function(e){return new t(e)},t.prototype.onOpen=function(t){this.option.warning&&console.warn("websocket connected"),this.option.onOpen&&this.option.onOpen(t),this.setHearBeat()},t.prototype.onClose=function(t){var e=this;this.option.onClose&&this.option.onClose(t),this.option.warning&&console.warn("websocket is closed,code:"+t.code),this.option.reconnect&&setTimeout((function(){e.reConnect()}),2e3)},t.prototype.onMessage=function(t){var e=this;this.option.onMessage&&this.option.onMessage(t),this.checkHeartBeat(t.data),this.option.forceDisconnectThreshold&&(clearTimeout(this.forceDisconnectTimer),this.forceDisconnectTimer=setTimeout((function(){e.option.warning&&console.warn(e.option.forceDisconnectThreshold+"ms seconds no message. Force disconnect"),e.close()}),this.option.forceDisconnectThreshold))},t.prototype.onError=function(t){this.option.onError&&this.option.onError(t)},t.prototype.send=function(t){if(this.ws){this.ws.readyState!==o.OPEN&&i("websocket has been closed or not ready yet!");var e=JSON.stringify(t);this.ws.send(e)}},t.prototype.close=function(){this.ws&&this.ws.readyState!==o.CLOSED&&(this.ws.readyState===o.CLOSING&&i("websocket is closing!"),this.heartBeatTimer&&(this.heartBeatTimer=void 0),this.heartBeatReceiptTimer&&(this.heartBeatReceiptTimer=void 0),this.ws.close())},t.prototype.reConnect=function(){this.option.warning&&console.warn("websocket connecting..."),this.option.onReconnecting&&this.option.onReconnecting(),this.createConnection()},t.prototype.setHearBeat=function(){var t=this,e=this.option.heartBeat,n=e.enable,i=e.sendMessage,s=e.sendInterval;n&&(this.heartBeatTimer=setInterval((function(){t.ws.readyState===o.OPEN&&(t.send({sub:i||"ping"}),t.heartBeatReceiptFlag=!0)}),s||1e3))},t.prototype.checkHeartBeat=function(t){var e=this,n=this.option.heartBeat,o=n.enable,i=n.receiveMessage,s=n.receiveInterval,r=n.breakOffHandler;o&&this.heartBeatReceiptFlag&&(this.messageHeartBeatCheckList.push(t),this.heartBeatReceiptTimer||(this.heartBeatReceiptTimer=setTimeout((function(){e.findHeartBeatReceipt(i)||(e.option.heartBeat.warning&&console.warn("heart beat message not found"),r&&r()),e.messageHeartBeatCheckList=[],e.heartBeatReceiptFlag=!1,e.heartBeatReceiptTimer=0}),s||1e3)))},t.prototype.findHeartBeatReceipt=function(t){return this.messageHeartBeatCheckList.some((function(e){switch(t.receivingStrategy){case n.absolutely:return e===t.pattern;case n.contain:return-1!==e.indexOf(t.pattern);case n.startsWidth:return e.startsWith(t.pattern);case n.endsWidth:return e.endsWith(t.pattern);case n.match:return-1!==e.search(t.regExp||/\*/);default:return e===t.pattern}}))},t}();module.exports=s;
