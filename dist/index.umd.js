!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).BigoIO=t()}(this,(function(){"use strict";var e;!function(e){e.match="match",e.contain="contain",e.absolutely="absolutely",e.startsWidth="startsWidth",e.endsWidth="endsWidth"}(e||(e={}));var t,n=e;!function(e){e[e.CONNECTING=0]="CONNECTING",e[e.OPEN=1]="OPEN",e[e.CLOSING=2]="CLOSING",e[e.CLOSED=3]="CLOSED"}(t||(t={}));var o=t;function i(e){throw new Error("[bigo-io warn]:"+e)}return function(){function e(t){this.messageQueue=[],this.reconnecting=!1,this.heartBeatReceiptFlag=!1,this.messageHeartBeatCheckList=[],this.openHandler=void 0,this.messageHandler=void 0,this.errorHandler=void 0,this.closeHandler=void 0,this.reconnectingHandler=void 0,this.reconnectedHandler=void 0,this.reconnectFailedHandler=void 0,this.checkOption(t),this.option=t,t.url.startsWith("/")?this.url=e.baseURL+t.url:this.url=t.url,this.createConnection()}return e.prototype.checkOption=function(e){void 0===window.WebSocket&&i("Your browser doesn't support websocket!"),e&&Object.keys(e).length||i("invalid options!"),e.url||i("invalid url!"),e.hooks||(e.hooks={})},e.prototype.createConnection=function(){this.ws||(this.ws=new WebSocket(this.url),this.ws.onopen=this.onOpenProxy.bind(this),this.ws.onclose=this.onCloseProxy.bind(this),this.ws.onmessage=this.onMessageProxy.bind(this),this.ws.onerror=this.onErrorProxy.bind(this))},e.create=function(t){return new e(t)},e.prototype.onOpen=function(e){this.ws&&(this.openHandler=e,this.ws.onopen=this.onOpenProxy.bind(this))},e.prototype.onOpenProxy=function(e){if(this.option.warning&&console.warn("websocket connected"),this.reconnecting&&(this.reconnecting=!1,this.option.hooks.onReconnected&&this.option.hooks.onReconnected(e),this.reconnectedHandler&&this.reconnectedHandler(e)),this.option.hooks.onOpen&&this.option.hooks.onOpen(e),this.openHandler&&this.openHandler(e),this.messageQueue.length)for(;this.messageQueue.length;){var t=this.messageQueue.shift();this.send(t)}this.setHearBeat()},e.prototype.onClose=function(e){this.ws&&(this.closeHandler=e,this.ws.onclose=this.onCloseProxy.bind(this))},e.prototype.onCloseProxy=function(e){var t=this;this.reconnecting&&(this.reconnecting=!1,this.option.hooks.onReconnectFailed&&this.option.hooks.onReconnectFailed(e),this.reconnectFailedHandler&&this.reconnectFailedHandler(e)),this.heartBeatTimer&&(clearInterval(this.heartBeatTimer),this.heartBeatTimer=void 0),this.heartBeatReceiptTimer&&(clearTimeout(this.heartBeatTimer),this.heartBeatReceiptTimer=void 0),this.ws=void 0,this.option.hooks.onClose&&this.option.hooks.onClose(e),this.closeHandler&&this.closeHandler(e),this.option.warning&&console.warn("websocket is closed,code:"+e.code),this.option.reconnect&&setTimeout((function(){t.reConnect()}),2e3)},e.prototype.onMessage=function(e){this.ws&&(this.messageHandler=e,this.ws.onmessage=this.onMessageProxy.bind(this))},e.prototype.onMessageProxy=function(e){var t=this;this.option.hooks.onMessage&&this.option.hooks.onMessage(e),this.messageHandler&&this.messageHandler(e),this.checkHeartBeat(e.data),this.option.forceDisconnectThreshold&&(clearTimeout(this.forceDisconnectTimer),this.forceDisconnectTimer=setTimeout((function(){t.option.warning&&console.warn(t.option.forceDisconnectThreshold+"ms seconds no message. Force disconnect"),t.close()}),this.option.forceDisconnectThreshold))},e.prototype.onError=function(e){this.ws&&(this.errorHandler=e,this.ws.onerror=this.onErrorProxy.bind(this))},e.prototype.onErrorProxy=function(e){this.option.hooks.onError&&this.option.hooks.onError(e),this.errorHandler&&this.errorHandler(e)},e.prototype.send=function(e){if(this.ws)if(this.ws.readyState!==o.CLOSED&&this.ws.readyState!==o.CLOSING||i("websocket has been closed!"),this.ws.readyState!==o.CONNECTING){var t=JSON.stringify(e);this.ws.send(t)}else this.messageQueue.push(e)},e.prototype.close=function(){this.ws&&this.ws.readyState!==o.CLOSED&&(this.ws.readyState===o.CLOSING&&i("websocket is closing!"),this.ws.close())},e.prototype.onReconnecting=function(e){e&&(this.reconnectingHandler=e)},e.prototype.onReconnected=function(e){e&&(this.reconnectedHandler=e)},e.prototype.onReconnectFailed=function(e){e&&(this.reconnectFailedHandler=e)},e.prototype.reConnect=function(){this.option.warning&&console.warn("websocket connecting..."),this.reconnecting=!0,this.option.hooks.onReconnecting&&this.option.hooks.onReconnecting(),this.reconnectingHandler&&this.reconnectingHandler(),this.createConnection()},e.prototype.setHearBeat=function(){var e=this,t=this.option.heartBeat,n=t.enable,i=t.sendMessage,s=t.sendInterval;n&&(this.heartBeatTimer=setInterval((function(){e.ws.readyState===o.OPEN&&(e.send(void 0===i?"ping":i),e.heartBeatReceiptFlag=!0)}),s||1e3))},e.prototype.checkHeartBeat=function(e){var t=this,n=this.option.heartBeat,o=n.enable,i=n.receiveMessage,s=n.receiveInterval,r=n.breakOffHandler;o&&this.heartBeatReceiptFlag&&(this.messageHeartBeatCheckList.push(e),this.heartBeatReceiptTimer||(this.heartBeatReceiptTimer=setTimeout((function(){t.findHeartBeatReceipt(i)||(t.option.heartBeat.warning&&console.warn("heart beat message not found"),r&&r()),t.messageHeartBeatCheckList=[],t.heartBeatReceiptFlag=!1,t.heartBeatReceiptTimer=0}),s||1e3)))},e.prototype.findHeartBeatReceipt=function(e){return this.messageHeartBeatCheckList.some((function(t){switch(e.receivingStrategy){case n.absolutely:return t===e.pattern;case n.contain:return-1!==t.indexOf(e.pattern);case n.startsWidth:return t.startsWith(e.pattern);case n.endsWidth:return t.endsWith(e.pattern);case n.match:return-1!==t.search(e.regExp||/\*/);default:return t===e.pattern}}))},e}()}));
